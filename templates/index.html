<!DOCTYPE html>
<html>
<head>
    <title>Indian Volume Scanner</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f0f2f5; }
        .container { max-width: 1200px; margin: auto; }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            padding: 30px; 
            border-radius: 10px; 
            margin-bottom: 20px;
            text-align: center;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover { background: #5a67d8; }
        .results { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stock-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
        }
        .stock-item:last-child { border-bottom: none; margin-bottom: 0; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .pattern-badge {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 20px;
            margin: 3px;
            font-size: 14px;
            display: inline-block;
        }
        .price-up { color: #10b981; }
        .price-down { color: #ef4444; }
        .info-text {
            background: #e0f2fe;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #0ea5e9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà Indian Volume Pattern Scanner</h1>
            <p>Real-time Volume Analysis ‚Ä¢ Free ‚Ä¢ No API Keys Required</p>
            <div style="font-size: 14px; margin-top: 10px; opacity: 0.9;">
                <span id="current-time">Loading...</span>
            </div>
        </div>
        
        <div class="info-text">
            <strong>‚ÑπÔ∏è How it works:</strong> Analyzes trading volume patterns of top Indian stocks to identify potential trading opportunities. Scans for 6 different volume patterns.
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn" onclick="scan('quick')">
                üöÄ Quick Scan (All Patterns)
            </button>
            <button class="btn" onclick="scan('v_pattern')">V-Pattern</button>
            <button class="btn" onclick="scan('u_pattern')">U-Pattern</button>
            <button class="btn" onclick="scan('3plus3')">3+3 Pattern</button>
            <button class="btn" onclick="scan('pyramid')">Pyramid</button>
            <button class="btn" onclick="scan('increasing')">Increasing</button>
            <button class="btn" onclick="scan('decreasing')">Decreasing</button>
        </div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn" onclick="checkStatus()" style="background: #6b7280;">
                üîÑ Check Server Status
            </button>
            <button class="btn" onclick="testYFinance()" style="background: #059669;">
                üß™ Test Data Source
            </button>
        </div>
        
        <div class="loader" id="loader"></div>
        
        <div class="results" id="results">
            <h3>Welcome to Volume Pattern Scanner!</h3>
            <p>Click any button above to start scanning.</p>
            <p>Features:</p>
            <ul>
                <li>‚úÖ <strong>6 different volume patterns</strong> (V, U, 3+3, Pyramid, Increasing, Decreasing)</li>
                <li>‚úÖ <strong>10+ Indian stocks</strong> (RELIANCE, TCS, INFY, HDFCBANK, etc.)</li>
                <li>‚úÖ <strong>Real analysis</strong> based on actual volume data</li>
                <li>‚úÖ <strong>100% Free</strong> hosting on Render</li>
                <li>‚úÖ <strong>No patterns = no results</strong> (shows "No patterns found" instead of fake data)</li>
            </ul>
            
            <div class="info-text">
                <strong>Note:</strong> The free Render tier sleeps after 15 minutes of inactivity. 
                First scan may take 10-15 seconds to wake up the server.
            </div>
        </div>
        
        <div id="test-results" style="margin-top: 20px;"></div>
    </div>

    <script>
        // Update current time
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                `Last updated: ${now.toLocaleTimeString()} | ${now.toLocaleDateString()}`;
        }
        setInterval(updateTime, 1000);
        updateTime();
        
        function showLoader() {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('results').innerHTML = '';
            document.getElementById('test-results').innerHTML = '';
        }
        
        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }
        
        async function scan(patternType) {
            showLoader();
            
            try {
                const response = await fetch(`/api/scan/${patternType}`);
                const data = await response.json();
                
                hideLoader();
                displayResults(data, patternType);
            } catch (error) {
                hideLoader();
                document.getElementById('results').innerHTML = `
                    <div style="color: red; padding: 20px; text-align: center;">
                        <h4>‚ö†Ô∏è Error Scanning</h4>
                        <p>Server might be sleeping. Please wait 15 seconds and try again.</p>
                        <p><small>Free tier sleeps after 15 minutes of inactivity</small></p>
                        <button class="btn" onclick="scan('${patternType}')" style="margin-top: 10px;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }
        
        function displayResults(data, patternType) {
            let html = `<h3>Scan Results (${patternType})</h3>`;
            
            // Check if data is empty
            if (!data || data.length === 0) {
                html += `
                    <div style="text-align: center; padding: 30px;">
                        <h4>üì≠ No ${patternType} patterns found</h4>
                        <p>No volume patterns detected in current market data.</p>
                        <p>Try:</p>
                        <ul style="text-align: left; display: inline-block;">
                            <li>Scanning a different pattern type</li>
                            <li>Trying again in 1-2 hours</li>
                            <li>Checking during market hours (9:15 AM - 3:30 PM IST)</li>
                        </ul>
                    </div>
                `;
                document.getElementById('results').innerHTML = html;
                return;
            }
            
            if (patternType === 'quick') {
                html += `<p>Found <strong>${data.length}</strong> stocks with patterns:</p>`;
                data.forEach(stock => {
                    const changeClass = stock.change >= 0 ? 'price-up' : 'price-down';
                    const changeSymbol = stock.change >= 0 ? '‚Üó' : '‚Üò';
                    html += `
                        <div class="stock-item">
                            <h4>${stock.symbol} - ‚Çπ${stock.price} 
                                <span class="${changeClass}">${changeSymbol} ${Math.abs(stock.change)}%</span>
                            </h4>
                            <div><strong>Patterns:</strong> ${stock.patterns.map(p => 
                                `<span class="pattern-badge">${p}</span>`
                            ).join(' ')}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 5px;">
                                Volume: ${stock.volume.toLocaleString()} | 
                                Sector: ${stock.sector || 'N/A'}
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `<p>Found <strong>${data.length}</strong> ${patternType} patterns:</p>`;
                data.forEach(item => {
                    const changeClass = item.change >= 0 ? 'price-up' : 'price-down';
                    const changeSymbol = item.change >= 0 ? '‚Üó' : '‚Üò';
                    html += `
                        <div class="stock-item">
                            <h4>${item.symbol} - ${item.pattern}</h4>
                            <p>
                                Price: ‚Çπ${item.price} 
                                <span class="${changeClass}">${changeSymbol} ${Math.abs(item.change)}%</span>
                            </p>
                            <p>Volume: ${item.volume.toLocaleString()}</p>
                            <div style="font-size: 13px; color: #666;">
                                ${item.sector || ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `<div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="scan('${patternType}')">üîÑ Rescan</button>
            </div>`;
            
            document.getElementById('results').innerHTML = html;
        }
        
        async function checkStatus() {
            showLoader();
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                hideLoader();
                document.getElementById('test-results').innerHTML = `
                    <div class="results">
                        <h4>‚úÖ Server Status: ${data.status}</h4>
                        <p>Patterns available: ${data.patterns?.join(', ') || 'N/A'}</p>
                        <p>Stocks tracked: ${data.stocks_tracked || '10+'}</p>
                        <p>Last check: ${new Date().toLocaleTimeString()}</p>
                    </div>
                `;
            } catch (error) {
                hideLoader();
                document.getElementById('test-results').innerHTML = `
                    <div class="results" style="background: #fee2e2;">
                        <h4>‚ùå Server Not Responding</h4>
                        <p>The server might be sleeping. Try clicking any scan button to wake it up.</p>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testYFinance() {
            showLoader();
            try {
                const response = await fetch('/api/test-yfinance');
                const data = await response.json();
                hideLoader();
                document.getElementById('test-results').innerHTML = `
                    <div class="results">
                        <h4>üß™ Data Source Test</h4>
                        <p>yFinance connection: ${data.success ? '‚úÖ SUCCESS' : '‚ùå FAILED'}</p>
                        <p>Data points: ${data.data_length || 0}</p>
                        <p>Test time: ${new Date().toLocaleTimeString()}</p>
                        ${data.error ? `<p style="color: red;">Error: ${data.error}</p>` : ''}
                    </div>
                `;
            } catch (error) {
                hideLoader();
                document.getElementById('test-results').innerHTML = `
                    <div class="results" style="background: #fee2e2;">
                        <h4>‚ùå Test Failed</h4>
                        <p>Cannot reach test endpoint. Server might be offline.</p>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Check if server is running on page load
        window.onload = async () => {
            try {
                await fetch('/api/status');
            } catch {
                console.log('App starting...');
            }
            updateTime();
        };
    </script>
</body>
</html>